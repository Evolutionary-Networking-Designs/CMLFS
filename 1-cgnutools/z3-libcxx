
# broken library:
# Error relocating /cgnutools/lib/libc++.so.1.0: __divti3: symbol not found
# due to libc++.so.1.0 still linking to a libgcc_s.so
# Temporary fix for missing divti3 symbol:
cp -v /cross-tools/${CMLFS_TARGET}/lib/libgcc_s.so.1 \
       /cgnutools/lib/

cd ${LLVMSRC}/projects/libcxx
cmake -B build -G Ninja \
      -DCMAKE_INSTALL_PREFIX="/cgnutools" \
      -DCMAKE_C_COMPILER="${CMLFS_TARGET}-gcc"     \
      -DCMAKE_CXX_COMPILER="${CMLFS_TARGET}-g++" \
      -DCMAKE_SHARED_LINKER_FLAGS="-L/cgnutools/lib" \
      -DLIBCXX_ENABLE_SHARED=ON \
      -DLIBCXX_ENABLE_STATIC=ON  \
      -DLIBCXX_HAS_MUSL_LIBC=ON \
      -DLIBCXX_HAS_GCC_S_LIB=ON \
      -DLIBCXXABI_ENABLE_STATIC=ON \
      -DLIBCXXABI_USE_LLVM_UNWINDER=ON \
      -DLIBCXX_CXX_ABI=libcxxabi \
      -DLIBCXX_CXX_ABI_LIBRARY_PATH="/cgnutools/lib" \
      -DLIBCXX_CXX_ABI_INCLUDE_PATHS="/cgnutools/include" \
      -DLLVM_PATH="${LLVMSRC}" 

ninja -C build         && \
ninja -C build install && \
rm -rf build           && \

# Link libcxx to final toolchain. Libraries will be replaced once
# libcxx is rebuilt with clang
ln -sv /cgnutools/lib/libc++*      /llvmtools/lib/
ln -sv /cgnutools/include/c++      /llvmtools/include/

