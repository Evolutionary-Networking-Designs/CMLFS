# Final System: Libelf 
# Source: https://sourceware.org/ftp/elfutils/0.183/elfutils-0.183.tar.bz2
# This section is done in Chroot environment

# Compile libelf with cross-tools
# Unpack a fresh copy of cross-tools
cd /
rm -rf /cross-tools
tar xf crosstools-gcc-$(uname -m).tar.xz

# Modify /cross-tools/etc/ld-musl-x86_64.path to search /usr/lib and /lib
echo "/usr/lib" >> /cross-tools/etc/ld-musl-x86_64.path
echo "/lib"     >> /cross-tools/etc/ld-musl-x86_64.path

# Return to elfutils source
cd /sources/elfutils-0.183

# Add missing files
cp -vr ../files/elfutils-void/error.h lib/
cp -vr ../files/elfutils-void/error.h src/

# Re-create configure script
autoreconf -ifv

# Configure source, using cross-tools
CC=x86_64-mlfs-linux-musl-gcc \
CXX=x86_64-mlfs-linux-musl-g++ \
AR=x86_64-mlfs-linux-musl-ar \
AS=x86_64-mlfs-linux-musl-as \
RANLIB=x86_64-mlfs-linux-musl-ranlib \
LD=x86_64-mlfs-linux-musl-ld \
STRIP=x86_64-mlfs-linux-musl-strip \
CFLAGS="-DFNM_EXTMATCH=0 -Wno-error -Wno-error=null-dereference -Wl,-z,stack-size=2097152 -L/lib -L/usr/lib -I/usr/include" \
./configure --prefix=/usr \
            --disable-debuginfod \
            --disable-libdebuginfod 

# Build it
make -C lib && make -C libelf

# Install library
make -C libelf install

# Install pkgconfig file for library
install -vm644 config/libelf.pc /usr/lib/pkgconfig
